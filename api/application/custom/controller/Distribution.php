<?php
/**
 * Created by PhpStorm.
 * User: 李佳飞
 * Date: 2017/12/14 0014
 * Time: 16:02
 * 后台管理员为每个小程序设置分销，设置分销的只有小程序有支付的时候，才能启用分销
 */
namespace app\custom\controller;
<<<<<<< HEAD
use think\Exception;
=======
>>>>>>> f3c10d5320de806fe333c38aaa4b99cf1c479c03

class Distribution extends Action{
    
    public function _initialize(){
        parent::_initialize(); // TODO: Change the autogenerated stub
        $this -> data = input('post.','','htmlspecialchars');
        if(!isset($this->data['appid'])){
            $return['code'] = 10100;
            $return['msg_test'] = 'appid参数值缺失';
            echo json_encode($return);exit;
        }
        if(!preg_match("/^\d{8}$/",$this -> data['appid'])){
            $return['code'] = 10200;
            $return['msg_test'] = 'appid格式不正确';
            echo json_encode($return);exit;
        }
        $custom_id = db('app') -> where(['appid' => $this->data['appid']]) -> value('custom_id');
        if($custom_id != $this->custom->id){
            $return['code'] = 10300;
            $return['msg_test'] = '当前app不是这个用户的';
            echo json_encode($return);exit;
        }
    }
<<<<<<< HEAD
    //提现审核
    public function withdraw_audit(){
        if (!isset($this->data['id']) || !isset($this->data['is_audit'])) {
            $return['code'] = 10001;
            $return['msg_test'] = '参数缺失';
            return json($return);
        }
        $audit_data['is_audit'] = $this->data['is_audit'];
        $audit_data['success_time'] = time();
        //审核通过
        if ($audit_data['is_audit'] == 1) {
            $res = db('withdraw_record')->where(['id' => $this->data['id']])->update($audit_data);
            if ($res) {
                $return['code'] = 10000;
                $return['msg_test'] = 'ok';
                return json($return);
            } else {
                $return['code'] = 10010;
                $return['msg_test'] = '网络错误，失败';
                return json($return);
            }
        }
        //审核未通过
        if ($audit_data['is_audit'] == 2) {
            $model = db();
            $model -> startTrans();
            try {
                 db('withdraw_record')->where(['id' => $this->data['id']])->update($audit_data);
                 $info = db('withdraw_record')->field('user_id,money')->where(['id' => $this->data['id']])->find();
                 db('user')->where(['id' => $info['user_id']])->setInc('money',$info['money']);
                 $model -> commit();   
                 $return['code'] = 10000;
                 $return['msg_test'] = 'ok';
                 return json($return);
            } catch (Exception $e) {
                $model -> rollback();
                $return['code'] = 10010;
                $return['msg_test'] = '网络错误,请稍后重试';
                return json($return);
            }
        }
    }
    //提现记录
    public function withdraw_list(){
        $page = isset($this->data['page']) ? $this->data['page'] : 1;
        $limit_num = isset($this->data['limit_num']) ? $this->data['limit_num'] : 10;
        $withdraw_data = array();
        $withdraw_data['appid'] = $this->data['appid'];
        if(isset($this->data['starttime']) && isset($this->data['endtime'])){
            if($this->data['starttime'] && $this->data['endtime']){
                $withdraw_data['create_time'] = ['between',[$this->data['starttime'],$this->data['endtime']]];
            }
        }
        if (isset($this->data['is_audit'])) {
            if ($this->data['is_audit']) {
                $withdraw_data['is_audit'] = $this->data['is_audit'];
            }
        }
        if (isset($this->data['withdraw_type'])) {
            if ($this->data['withdraw_type']) {
                $withdraw_data['withdraw_type'] = $this->data['withdraw_type'];
            }
        }
        if (isset($this->data['tel'])) {
            if ($this->data['tel']) {
                $withdraw_data['tel'] = $this->data['tel'];
            }
        }
        if (isset($this->data['name'])) {
            if ($this->data['name']) {
                $withdraw_data['name'] = $this->data['name'];
            }
        }
        $info = db('withdraw_record')
        ->field('id,name,tel,money,withdraw_type,ali_number,bank_name,bank_number,is_audit,create_time,success_time')
        ->where($withdraw_data)
        ->order('id desc')
        ->page($page,$limit_num)
        ->select();
        $return['code'] = 10000;
        $return['msg_test'] = '查询成功';
        $return['data'] = $info;
        return json($return);
    }
    //分销详情
    public function getDistInfo() {
        $info = db('dist_rule')
            -> field('switch,level,scale,type,good_list,is_withdraw,withdraw_type')
=======
    //分销详情
    public function getDistInfo() {
        $info = db('dist_rule')
            -> field('appid,switch,level,scale,type,good_list,is_withdraw,withdraw_type')
>>>>>>> f3c10d5320de806fe333c38aaa4b99cf1c479c03
            ->where(['appid' => $this->data['appid']]) -> find();

        $return['code'] = 10000;
        $return['msg_test'] = '查询成功';
        $return['data'] = $info;
        return json($return);
        
    }
    //分销设置
    public function setDist() {
        if (!isset($this->data['is_withdraw']) || !isset($this->data['type']) || !isset($this->data['scale']) || !isset($this->data['level']) || !isset($this->data['switch'])) {
            $return['code'] = 10001;
            $return['msg_test'] =  '参数缺失';
            return  json($return);
        }
        $dist_data = array();
		$dist_data['appid'] = $this->data['appid'];
		$dist_data['custom_id'] = $this->custom['id'];
		$dist_data['is_withdraw'] = $this->data['is_withdraw'];
		$dist_data['type'] = $this->data['type'];
		$dist_data['scale'] = $this->data['scale'];
		$dist_data['level'] = $this->data['level'];
		$dist_data['switch'] = $this->data['switch'];
		$dist_data['type'] = $this->data['type'];
		$dist_data['good_list'] = $this->data['good_list'];
		$dist_data['withdraw_type'] = $this->data['withdraw_type'];
        $id = db('dist_rule')->where(['appid' => $dist_data['appid']])->value('id');
        if (!$id ) {
            $res = db('dist_rule')->insert($dist_data);
            if($res){
                $return['code'] = 10000;
                $return['msg'] = '保存成功';
                return json($return);
            }else{
                $return['code'] = 10010;
                $return['msg'] = '网络错误,保存失败';
                return json($return);
            }
        } else {
            $res = db('dist_rule')->where(['id' => $id])->update($dist_data);
            if(isset($res)){
                $return['code'] = 10000;
                $return['msg'] = '保存成功';
                return json($return);
            }else{
                $return['code'] = 10010;
                $return['msg'] = '网络错误,保存失败';
                return json($return);
            }
        }
    }

    /*分销记录*/
    public  function dist_list(){

        $limit = isset($this->data['limit']) ? $this->data['limit'] : 10;
        $page = isset($this->data['page']) ? $this->data['page'] : 1;

        if (!isset($this->data['appid'])) {
            $return['code'] = 10002;
            $return['msg_test'] =  '小程序参数丢失';
            return  json($return);
        }
<<<<<<< HEAD
        $num = db('dist_record')
            -> where(['appid' => $this->data['appid']])
            -> count();
=======
>>>>>>> f3c10d5320de806fe333c38aaa4b99cf1c479c03
        $info = db('dist_record')
            -> alias('a')
            -> field('a.id,a.order_id,a.user_id,a.xj_userid,a.money,a.level,a.create_time,a.type,b.nickName as user_nickName,c.nickName as xj_nickName')
            -> join("__USER__ b",'a.user_id = b.id','LEFT')
            -> join("__USER__ c",'a.xj_userid = c.id','LEFT')
            -> where(['appid' => $this->data['appid']])
            -> page($page,$limit)
            -> order('a.create_time desc')
            -> select();

<<<<<<< HEAD
        $return['code'] = 10000;
        $return['data'] = ['number'=>$num,'data'=>$info] ;
=======
        $return['code'] = 10010;
        $return['data'] = $info ;
>>>>>>> f3c10d5320de806fe333c38aaa4b99cf1c479c03
        return json($return);

    }
}